name: Build Arch Linux Universal Netinstaller (yay-powered)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Build Environment
        run: |
          docker run --rm --entrypoint /bin/sh -v "${{ github.workspace }}":/work archlinux:latest -c "pacman -Syu --noconfirm && pacman -S --noconfirm --needed git base-devel archiso wget"

      - name: Create ISO Profile and Configuration
        run: |
          docker run --rm --entrypoint /bin/sh -v "${{ github.workspace }}":/work -w /work archlinux:latest -c '
            # 1. Create archiso profile from template
            cp -r /usr/share/archiso/configs/releng/ archlive

            # 2. Define minimal package list for the live ISO
            cat <<EOF > archlive/packages.x86_64
            base linux linux-firmware sudo
            grub mtools syslinux edk2-shell
            archiso calamares networkmanager
            xorg-server xorg-xinit openbox tint2
            wget git fastfetch
            EOF

            # 3. Create all necessary Calamares config files
            mkdir -p archlive/airootfs/etc/calamares/modules
            mkdir -p archlive/airootfs/etc/calamares/scripts

            # --- settings.conf ---
            # This now uses unpackfs (for base), shellprocess (for yay), and netinstall (for everything else)
            cat <<EOF > archlive/airootfs/etc/calamares/settings.conf
            modules-load:
              - welcome
              - keyboard
              - partition
              - unpackfs
              - shellprocess
              - netinstall
              - users
              - bootloader
              - displaymanager
              - finished
            branding: archlinux
            prompt-install: false
            -id: preserve-user-home-on-reinstall
            EOF

            # --- unpackfs.conf ---
            # Installs the bare minimum system from the live ISO
            cat <<EOF > archlive/airootfs/etc/calamares/modules/unpackfs.conf
            ---
            unpack:
              - source: "/run/archiso/bootmnt/arch/x86_64/airootfs.sfs"
                sourcefs: "squashfs"
                destination: ""
            EOF

            # --- shellprocess.conf ---
            # Defines the job to install yay onto the new system
            cat <<EOF > archlive/airootfs/etc/calamares/modules/shellprocess.conf
            ---
            scripts:
              - script:
                  - calamares-chroot-script "/etc/calamares/scripts/install_yay.sh"
                timeout: 600
                comment: "Installing AUR Helper (yay)..."
            EOF

            # --- install_yay.sh Script ---
            # This script is executed in the chroot to build and install yay
            cat <<'"EOF"' > archlive/airootfs/etc/calamares/scripts/install_yay.sh
            #!/bin/bash
            pacman -S --noconfirm --needed git base-devel
            useradd -m builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            sudo -u builder bash -c "cd /home/builder && git clone https://aur.archlinux.org/yay.git && cd yay && makepkg --noconfirm -si"
            userdel -r builder
            sed -i "/builder/d" /etc/sudoers
            EOF
            chmod +x archlive/airootfs/etc/calamares/scripts/install_yay.sh
            
            # --- netinstall.conf ---
            # Configures the netinstall module to use our new YAML file and yay
            cat <<EOF > archlive/airootfs/etc/calamares/modules/netinstall.conf
            ---
            source: "/etc/calamares/netinstall.yaml"
            preScript: "yay -Syu --noconfirm"
            install:
                - "yay -S --noconfirm"
            EOF

            # --- netinstall.yaml (The Big Package List) ---
            # This defines all the groups and choices the user will see.
            cat <<'EOF' > archlive/airootfs/etc/calamares/netinstall.yaml
            packages:
              - name: "üñ•Ô∏è Desktop Environments"
                description: "Full-featured desktop environments."
                selected: true
                packages:
                  - plasma-meta: "KDE Plasma"
                  - gnome: "GNOME"
                  - xfce4: "XFCE"
                  - cinnamon: "Cinnamon"
              - name: "ü™ü Window Managers"
                description: "Lightweight and tiling window managers."
                packages: [i3-wm, sway, hyprland, bspwm, awesome]
              - name: "üí° Display Managers"
                description: "Graphical login managers."
                packages: [sddm, gdm, lightdm]
              - name: "üß† Kernels"
                packages: [linux-lts, linux-zen]
              - name: "üêö Shells"
                packages: [zsh, fish]
              - name: "üåê Web Browsers"
                packages:
                  - firefox
                  - chromium
                  - brave: "Brave Browser (AUR)"
              - name: "üõ†Ô∏è Development"
                packages: [neovim, code, git, docker, podman, python, nodejs, npm, rust, go]
              - name: "üé® Graphics & Design"
                packages:
                  - gimp
                  - krita
                  - inkscape
                  - blender
                  - archlinux-artwork: "Arch Linux Artwork (AUR)"
              - name: "üé¨ Multimedia"
                packages: [vlc, mpv, obs-studio, kdenlive, audacity]
              - name: "‚úçÔ∏è Office"
                packages: [libreoffice-fresh, onlyoffice-desktopeditors]
              - name: "üéÆ Gaming"
                packages:
                  - steam
                  - lutris
                  - wine
                  - gamemode
                  - 0ad
                  - supertuxkart
                  - classicube: "ClassiCube (AUR)"
              - name: "‚öôÔ∏è Utilities"
                packages: [gparted, timeshift, keepassxc, qbittorrent, btop]
            EOF

            # --- Other Calamares Modules ---
            mkdir -p archlive/airootfs/etc/calamares/branding/archlinux
            cat <<EOF > archlive/airootfs/etc/calamares/branding/archlinux/branding.desc
            componentName: archlinux
            welcomeText: "<h2>Welcome to the Universal Arch Linux Installer.</h2><p>This installer uses <b>yay</b> to install packages from official repositories and the AUR. An internet connection is required.</p>"
            EOF
            cat <<EOF > archlive/airootfs/etc/calamares/modules/bootloader.conf
            ---
            bootloader: "grub"
            efi_directory: "/boot"
            grub_install_args: ["--bootloader-id=arch"]
            EOF
            cat <<EOF > archlive/airootfs/etc/calamares/modules/displaymanager.conf
            ---
            displaymanagers:
              - {name: "SDDM", service: "sddm.service"}
              - {name: "GDM", service: "gdm.service"}
              - {name: "LightDM", service: "lightdm.service"}
            default: "sddm"
            EOF
            cat <<EOF > archlive/airootfs/etc/calamares/modules/partition.conf
            ---
            efiSystemPartition: "/boot"
            efiSystemPartitionSize: 512M
            create-swap: true
            swap-size: 2048M
            default-filesystem: "ext4"
            EOF
            cat <<EOF > archlive/airootfs/etc/calamares/modules/finished.conf
            ---
            reboot-now: true
            EOF
            
            # Autostart Calamares
            mkdir -p archlive/airootfs/etc/systemd/system/getty@tty1.service.d/
            cat <<EOF > archlive/airootfs/etc/systemd/system/getty@tty1.service.d/autologin.conf
            [Service]
            ExecStart=
            ExecStart=-/usr/bin/agetty --autologin root --noclear %I \$TERM
            EOF
            cat <<EOF > archlive/airootfs/root/.xinitrc
            #!/bin/sh
            openbox &
            tint2 &
            calamares --fullscreen
            EOF
            chmod +x archlive/airootfs/root/.xinitrc
            cat <<EOF > archlive/airootfs/root/.bash_profile
            [[ -z \$DISPLAY && \$XDG_VTNR -eq 1 ]] && startx
            EOF

            # Main ISO profile config
            cat <<EOF > archlive/profile.conf
            iso_name="archlinux-universal-installer"
            iso_label="ARCH_YAY_$(date +%Y%m)"
            iso_publisher="KrzysTheTech"
            iso_application="Arch Linux Universal Netinstaller"
            iso_version="$(date +%Y.%m.%d)"
            install_dir="arch"
            buildmodes=('iso')
            bootmodes=('bios.syslinux.mbr bios.syslinux.eltorito uefi-shell uefi-ia32.grub.esp uefi-x64.grub.esp')
            airootfs_image_tool_options=('-comp' 'xz' '-b' '1M')
            file_permissions=(["/etc/shadow"]="0:0:400" ["/root"]="0:0:750")
            EOF
          '

      - name: Build the ISO in a Privileged Container
        uses: add-ons/docker-run-action@v1
        with:
          image: archlinux:latest
          options: -v ${{ github.workspace }}:/github/workspace --privileged
          run: |
            cd /github/workspace
            mkarchiso -v -w work -o out archlive

      - name: Set Timestamp for Artifact Name
        run: echo "TIMESTAMP=$(date +%Y.%m.%d)" >> $GITHUB_ENV

      - name: Upload ISO as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-universal-installer-${{ env.TIMESTAMP }}-x86_64.iso
          path: out/*.iso
